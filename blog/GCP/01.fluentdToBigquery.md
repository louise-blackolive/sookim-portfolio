# Fluentd 로 수집한 NGINX의 로그를 BigQuery로 스트리밍 전송하기

## 1. 개요
Fluentd는 많은 유저들이 사용하는 로그수집 프로그램으로서 많은 데이터소스를 지원하고있다. fluentd를 이용하여 수집 된 데이터를 스토리지에 쌓는 과정을 없애고 바로 BigQuery 테이블로 저장하여 BigQuery에서 데이터를 끌어오는 시간을 단축 할 수 있다. 
Fluentd에서 제공하는 [output plugin](https://docs.fluentd.org/output)은 file, AWS s3, kafka, elasticsearch 등 다양한 타겟포맷을 지원하고있고, 그 중 BigQuery도 지원하고 있으므로 해당 플러그인으로 실습을 진행한다. 
Fluentd를 통해 수집 할 수 있는 로그는 매우 다양하지만 이 실습에서는 일반적으로 사용하는 웹 어플리케이션인 NGINX를 기준으로 발생 된 HTTP 접속 로그를 활용하여 수집, 저장, 분석에 대해 실습한다.

## 2. 여기서 사용하는 서비스
<hr/>
2-1. Infra
   * Google Cloud Platform
   * BigQuery
   * GCE

2-2. Software
   * Linux Debian
   * Fluentd
   * NGINX

## 3. 실습 요약
<hr/>

1) Compute Engine 인스턴스에서 NGINX 웹 서버를 실행
2) Fluentd 로그 수집 에이전트를 설치
3) 다음 작업을 수행하도록 Fluentd를 구성
   * NGINX 트래픽 로그 수집
   * BigQuery로 로그 전달
1) BigQuery 웹 UI를 사용하여 로그 메시지를 쿼리
2) BigQuery를 사용하여 로그 분석 쿼리를 실행

## 4. How-to
<hr/>

### 4-1. NGINX 웹 서버 만들기
이 과정에서 GCP Marketplace에 지정 된 NGINX 이미지를 통해 GCE를 생성하여 설치단계를 단축합니다.
* [NGINX Marketplace 페이지로 이동](https://console.cloud.google.com/marketplace/details/click-to-deploy-images/nginx?hl=ko&_ga=2.124384266.-1099422431.1543797902)
* [COMPUTE ENGINE에서 실행] 버튼을 클릭
* GCE를 생성 할 프로젝트를 선택하고 API가 활성화 될 때 까지 잠시 기다린다.
* **Deployment name** : NGINX 입력
* **방화벽** : Allow HTTP traffic from the Internet 체크
* [배포] 버튼을 클릭하여 GCE 배포를 시작

### 4-2. GCE 권한 설정하기
GCE에 있는 Fluentd가 Bigquery에 접근 할 수 있도록 적절한 권한을 줍니다.
* GCE 인스턴스 페이지로 이동하여 VM의 이름을 클릭하여 세부정보로 이동합니다.
* 페이지 상단의 [중지] 버튼을 클릭하여 VM을 잠시 종료합니다.
* 페이지 상단의 [수정] 을 클릭하고 BigQuery 액세스를 **사용설정됨**으로 변경합니다.
* 페이지 하단의 [저장] 을 클릭 후 [시작]을 눌러 VM을 부팅합니다.

### 4-3. Fluentd 및 BigQuery 커넥터 설치
이 단계에서는 데비안 계열에 맞는 Fluentd 를 설치하고 BigQuery용 출력 플러그인을 GCE에 설치합니다.
* VM 인스턴스 목록에서 SSH 버튼을 클릭하여 콘솔에 접속합니다.
* 아래와 같은 명령어로 Debian 버젼을 확인합니다.
  ```console
  sookim@nginx-1-vm:~$ lsb_release -rdc
  Description:    Debian GNU/Linux 9.11 (stretch)
  Release:        9.11
  Codename:       stretch
  ```
* [Fluentd 설치 도큐먼트](https://docs.fluentd.org/installation/install-by-deb)로 이동하여 OS와 버전에 맞는 설치 명령어를 복사하여 실행합니다.
  ```
  sookim@nginx-1-vm:~$ curl -L https://toolbelt.treasuredata.com/sh/install-debian-stretch-td-agent3.sh | sh

    % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                    Dload  Upload   Total   Spent    Left  Speed
    100   853  100   853    0     0   6277      0 --:--:-- --:--:-- --:--:--  6318
    ==============================
    td-agent Installation Script 
    ==============================
    This script requires superuser access to install apt packages.
    You will be prompted for your password by sudo.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
    100  3157  100  3157    0     0  14813      0 --:--:-- --:--:-- --:--:-- 14821
    ...
    ...
    Installation completed. Happy Logging!
    ```
* 아래 명령어를 통해 Fluentd-to-BigQuery 플러그인을 설치합니다
  ```
  sookim@nginx-1-vm:~$ sudo /usr/sbin/td-agent-gem install fluent-plugin-bigquery

  
